#!/usr/bin/env bash
set -euo pipefail

CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/gh-pr-status"
CACHE_FILE="$CACHE_DIR/state.json"
mkdir -p "$CACHE_DIR"

prs=$(gh search prs --author @me --state open --json 'repository,number' --jq '
  [.[] | {repo: .repository.nameWithOwner, number}]
')

count=$(echo "$prs" | jq 'length')

if [ "$count" -eq 0 ]; then
  echo '{"text": "", "class": "none"}'
  echo '{}' > "$CACHE_FILE"
  exit 0
fi

# load previous state
prev='{}'
[ -f "$CACHE_FILE" ] && prev=$(cat "$CACHE_FILE")

current='{}'
has_failed=false
has_pending=false

for row in $(echo "$prs" | jq -r '.[] | "\(.repo)|\(.number)"'); do
  repo="${row%|*}"
  number="${row#*|}"
  status=$(gh pr view "$number" -R "$repo" --json 'statusCheckRollup,title' --jq '
    (.title) + "|" +
    (if [.statusCheckRollup[]? | select(.conclusion == "FAILURE")] | length > 0 then "failed"
    elif [.statusCheckRollup[]? | select(.status == "IN_PROGRESS" or .status == "QUEUED" or .status == "PENDING" or .conclusion == "")] | length > 0 then "pending"
    else "passed"
    end)
  ' 2>/dev/null || echo "|passed")

  title="${status%|*}"
  state="${status#*|}"
  key="${repo}#${number}"

  current=$(echo "$current" | jq --arg k "$key" --arg s "$state" --arg t "$title" '. + {($k): {state: $s, title: $t}}')

  prev_state=$(echo "$prev" | jq -r --arg k "$key" '.[$k].state // ""')

  if [ -n "$prev_state" ] && [ "$prev_state" != "$state" ]; then
    case "$state" in
      passed)  notify-send -u normal "CI passed" "$title" ;;
      failed)  notify-send -u critical "CI failed" "$title" ;;
      pending) notify-send -u low "CI running" "$title" ;;
    esac
  fi

  case "$state" in
    failed)  has_failed=true ;;
    pending) has_pending=true ;;
  esac
done

echo "$current" > "$CACHE_FILE"

if [ "$has_failed" = "true" ]; then
  echo '{"text": "✗", "class": "failing"}'
elif [ "$has_pending" = "true" ]; then
  echo '{"text": "●", "class": "pending"}'
else
  echo '{"text": "✓", "class": "passing"}'
fi
